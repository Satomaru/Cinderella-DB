<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org" lang="ja">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
		<link rel="stylesheet" href="../../static/standard.css" th:href="@{/standard.css}">
		<script src="../../static/common.js" th:src="@{/common.js}"></script>
		<title th:text="|${pageTitle} - #{application.title}|">title</title>

		<style>
			button.disc {
				background-color: #888;
			}
		</style>

		<script>
			function search(form, event) {
				event.preventDefault();

				const target = encodeURI(form.target.value);
				const match = encodeURI(form.match.value);
				const tbody = document.getElementById("discList");
				const url = `../api/discs/?target=${target}&match=${match}`;

				fetch(url)
					.then(function(response){
						if (response.status !== 200) {
							throw `検索に失敗しました。(${response.status})`;
						}

						return response.text();
					})
					.then(function(text) {
						tbody.innerText = null;

						JSON.parse(text).forEach(function(row) {
							const buttonName = Common.Element.create("button", {
								type: "button",
								className: "disc w-100 border rounded text-white text-start",
								children: [row.name]
							})

							const divKana = Common.Element.create("div", {
								className: "ps-3 fw-light",
								children: [row.kana]
							});

							const tdCodeSpec = { children: [] };

							if (!Common.Eval.isNullish(row.code)) {
								if (!Common.Eval.isNullish(row.site)) {
									const iSite = Common.Element.create("i", {
										className: "bi bi-box-arrow-up-right"
									});

									const aSite = Common.Element.create("a", {
										href: row.site,
										target: "_blank",
										className: "text-decoration-none",
										children: [row.code, " ", iSite]
									});

									tdCodeSpec.children.push(aSite);
								} else {
									tdCodeSpec.children.push(row.code);
								}
							}

							const tdName = Common.Element.create("td", { children: [buttonName, divKana] });
							const tdLabel = Common.Element.create("td", { children: [row.label] });
							const tdCode = Common.Element.create("td", tdCodeSpec);
							const tr = Common.Element.create("tr", { children: [tdName, tdLabel, tdCode] });
							tbody.append(tr);
						});

						document.getElementById("targetsTab").click();
					})
					.catch(function(error) {
						alert(error);
					});
			}
		</script>
	</head>

	<body>
		<header th:replace="tracks/common :: header(~{::form})" class="container">
			<form class="h-100 mb-2 p-2 bg-light border rounded-bottom" onsubmit="search(this, event)">
				<div class="row align-items-center">
					<div class="col-auto pe-1">
						<select name="target" class="form-select">
							<option value="name" selected>名前</option>
							<option value="kana">かな</option>
							<option value="label">レーベル</option>
							<option value="code">コード</option>
						</select>
					</div>

					<div class="col-auto ps-1">
						<input name="match" type="text" class="form-control" autofocus>
					</div>

					<div class="col text-end">
						<button type="submit" class="btn btn-primary">検索</button>
					</div>
				</div>
			</form>
		</header>

		<main th:replace="tracks/common :: main(~{::table})" class="container">
			<table class="table">
				<thead>
					<tr>
						<th scope="col" style="width: 40em;">名前 / かな</th>
						<th scope="col">レーベル</th>
						<th scope="col">コード</th>
					</tr>
				</thead>
				<tbody id="discList"></tbody>
			</table>
		</main>

		<footer th:replace="index :: footer"></footer>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
	</body>
</html>
