<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org" lang="ja">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
		<link rel="stylesheet" th:href="@{/standard.css}">

		<title>Tracks - Cinderella DB</title>

		<style>
			#idolsTable .btn {
				width: 12em;
			}

			#musicsTable .btn {
				width: 23em;
			}
		</style>

		<script>
			function showTable(button) {
				document.getElementById("idolsTable").style.display  = (button.id === "navIdolsTab")  ? "table" : "none";
				document.getElementById("musicsTable").style.display = (button.id === "navMusicsTab") ? "table" : "none";
				document.getElementById("discsTable").style.display  = (button.id === "navDiscsTab")  ? "table" : "none";
			}

			function searchIdols() {
				const form = document.getElementById("idolsForm");
				const target = encodeURI(form.target.value);
				const match = encodeURI(form.match.value);
				const type = encodeURI(form.type.value);
				const table = document.getElementById("idolsTable");
				const tbody = table.getElementsByTagName("tbody")[0];

				fetch(`api/idols/?target=${target}&match=${match}&type=${type}`)
					.then(function(response){
						if (response.status !== 200) {
							throw `検索に失敗しました。(${response.status})`;
						}

						return response.text();
					})
					.then(function(text) {
						tbody.innerText = null;

						JSON.parse(text).forEach(function(row) {
							const buttonName = document.createElement("button");
							const tdName = document.createElement("td");
							const tdKana = document.createElement("td");
							const tdBirth = document.createElement("td");
							const tdCv = document.createElement("td");
							const tr = document.createElement("tr");

							buttonName.type = "button";
							buttonName.className = `btn type-${row.type}`;
							buttonName.innerText = row.name;

							tdName.appendChild(buttonName);
							tdKana.innerText = row.kana;
							tdBirth.innerText = row.birth.substring(0, 2) + "-" + row.birth.substring(2, 4);
							tdCv.innerText = row.cv;

							tr.appendChild(tdName);
							tr.appendChild(tdKana);
							tr.appendChild(tdBirth);
							tr.appendChild(tdCv);
							tbody.appendChild(tr);
						});
					})
					.catch(function(error) {
						alert(error);
					});
			}

			function searchMusics() {
				const form = document.getElementById("musicsForm");
				const target = encodeURI(form.target.value);
				const match = encodeURI(form.match.value);
				const original = form.original.checked ? encodeURI(form.original.value) : "";
				const table = document.getElementById("musicsTable");
				const tbody = table.getElementsByTagName("tbody")[0];

				fetch(`api/musics/?target=${target}&match=${match}&original=${original}`)
					.then(function(response){
						if (response.status !== 200) {
							throw `検索に失敗しました。(${response.status})`;
						}

						return response.text();
					})
					.then(function(text) {
						tbody.innerText = null;

						JSON.parse(text).forEach(function(row) {
							const buttonName = document.createElement("button");
							const tdName = document.createElement("td");
							const tdKana = document.createElement("td");
							const tdLyrics = document.createElement("td");
							const tdCompose = document.createElement("td");
							const tdCover = document.createElement("td");
							const tr = document.createElement("tr");

							buttonName.type = "button";
							buttonName.className = "btn type-Non";
							buttonName.innerText = row.name;

							tdName.appendChild(buttonName);
							tdKana.innerText = row.kana;
							tdLyrics.innerText = row.lyrics;
							tdCompose.innerText = row.compose;

							if (row.cover) {
								const coverIcon = document.createElement("i");
								coverIcon.className = "bi bi-chat-square-quote";
								tdCover.appendChild(coverIcon);
							}

							tr.appendChild(tdName);
							tr.appendChild(tdKana);
							tr.appendChild(tdLyrics);
							tr.appendChild(tdCompose);
							tr.appendChild(tdCover);
							tbody.appendChild(tr);
						});
					})
					.catch(function(error) {
						alert(error);
					});
			}
		</script>
	</head>

	<body>
		<header id="pageHeader" class="sticky-top">
			<nav class="navbar navbar-expand-sm navbar-dark">
				<div class="container-fluid">
					<ul class="navbar-nav">
						<li class="nav-item"><a class="nav-link" th:href="@{/}">Cinderella DB</a></li>
						<li class="nav-item"><span class="nav-link active" aria-current="page">Tracks</span></li>
						<li class="nav-item"><a class="nav-link" th:href="@{/elections}">Elections</a></li>
						<li class="nav-item"><a class="nav-link" th:href="@{/lives}">Lives</a></li>
						<li class="nav-item"><a class="nav-link" th:href="@{/utility}">Utility</a></li>
					</ul>
				</div>
			</nav>

			<div class="container mb-0 bg-white">
				<nav>
					<div class="nav nav-tabs" role="tablist">
						<button id="navIdolsTab"
							class="nav-link active"
							data-bs-toggle="tab"
							data-bs-target="#idolsForm"
							type="button"
							role="tab"
							aria-controls="idolsForm"
							aria-selected="true"
							onclick="showTable(this);"><i class="bi bi-person-square"></i> By Idol</button>

						<button id="navMusicsTab"
							class="nav-link"
							data-bs-toggle="tab"
							data-bs-target="#musicsForm"
							type="button"
							role="tab"
							aria-controls="musicsForm"
							aria-selected="false"
							onclick="showTable(this);"><i class="bi bi-music-note"></i> By Music</button>

						<button id="navDiscsTab"
							class="nav-link"
							data-bs-toggle="tab"
							data-bs-target="#discsForm"
							type="button"
							role="tab"
							aria-controls="discsForm"
							aria-selected="false"
							onclick="showTable(this);"><i class="bi bi-disc"></i> By Disc</button>
					</div>
				</nav>

				<div class="tab-content">
					<form id="idolsForm"
						class="tab-pane show active h-100 p-2 mb-2 bg-light border rounded-bottom"
						role="tabpanel"
						aria-labelledby="navIdolsTab"
						onsubmit="return false;">

						<div class="row align-items-center">
							<div class="col-auto">
								<select name="target" class="form-select">
									<option value="name" selected>名前</option>
									<option value="kana">かな</option>
								</select>
							</div>
							<div class="col-auto">
								<input name="match" type="text" class="form-control" autofocus>
							</div>
							<div class="col-auto">
								タイプ
							</div>
							<div class="col-auto">
								<div class="form-check form-check-inline">
									<label class="form-check-label"><input name="type" type="radio" value="" class="form-check-input" checked> All</label>
								</div>
								<div class="form-check form-check-inline">
									<label class="form-check-label"><input name="type" type="radio" value="Cu" class="form-check-input"> Cu</label>
								</div>
								<div class="form-check form-check-inline">
									<label class="form-check-label"><input name="type" type="radio" value="Pa" class="form-check-input"> Pa</label>
								</div>
								<div class="form-check form-check-inline">
									<label class="form-check-label"><input name="type" type="radio" value="Co" class="form-check-input"> Co</label>
								</div>
							</div>
							<div class="col" style="text-align: right;">
								<button type="button" class="btn btn-primary" onclick="searchIdols()">検索</button>
							</div>
						</div>
					</form>

					<form id="musicsForm"
						class="tab-pane h-100 p-2 mb-2 bg-light border rounded-bottom"
						role="tabpanel"
						aria-labelledby="navMusicsTab"
						onsubmit="return false;">

						<div class="row align-items-center">
							<div class="col-auto">
								<select name="target" class="form-select">
									<option value="name" selected>名前</option>
									<option value="kana">かな</option>
								</select>
							</div>
							<div class="col-auto">
								<input name="match" type="text" class="form-control" autofocus>
							</div>
							<div class="col-auto">
								<label><input name="original" type="checkbox" value="1" class="form-check-input"> カバーを除く</label>
							</div>
							<div class="col" style="text-align: right;">
								<button type="button" class="btn btn-primary" onclick="searchMusics();">検索</button>
							</div>
						</div>
					</form>

					<form id="discsForm"
						class="tab-pane h-100 p-2 mb-2 bg-light border rounded-bottom"
						role="tabpanel"
						aria-labelledby="navDiscsTab"
						onsubmit="return false;">

						<div class="row align-items-center">
							<div class="col-auto">
								<select name="target" class="form-select">
									<option value="name" selected>名前</option>
									<option value="kana">かな</option>
								</select>
							</div>
							<div class="col-auto">
								<input name="match" type="text" class="form-control" autofocus>
							</div>
							<div class="col" style="text-align: right;">
								<button type="button" class="btn btn-primary">検索</button>
							</div>
						</div>
					</form>
				</div>
			</div>
		</header>

		<div id="pageContent" class="container">
			<table id="idolsTable" class="table">
				<thead>
					<tr>
						<th scope="col">名前</th>
						<th scope="col">かな</th>
						<th scope="col">誕生日</th>
						<th scope="col">CV</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>

			<table id="musicsTable" class="table" style="display: none;">
				<thead>
					<tr>
						<th scope="col">名前</th>
						<th scope="col">かな</th>
						<th scope="col">作詞</th>
						<th scope="col">作曲</th>
						<th scope="col" style="white-space:nowrap">カバー</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>

			<table id="discsTable" class="table" style="display: none;">
				<thead>
					<tr>
						<th scope="col">名前</th>
						<th scope="col">かな</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>

		<footer id="pageFooter" class="fixed-bottom">
			made by STB a.k.a. Satomaru <a href="https://twitter.com/stb_nissie"><i class="bi bi-twitter"></i></a>
		</footer>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
	</body>
</html>
